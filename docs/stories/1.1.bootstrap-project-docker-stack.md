# Status
Approved

# Story
**As a** self-hosting administrator,
**I want** to run a single `docker compose up` command,
**so that** the web app, API, worker, and Postgres come online with sensible defaults.

# Acceptance Criteria
1. `docker-compose.yml` defines web, api, worker, and Postgres services with shared network/volumes.
2. `.env.example` lists required variables (DB credentials, JWT/Session secret, initial admin flag) and startup fails fast if any are missing.
3. API performs database migrations on first boot to create core tables (admin_users, calendars, connectors, sync_jobs, audit_logs).
4. API `/healthz` and worker heartbeat output are observable successfully within 5 seconds of stack start.

# Tasks / Subtasks
- [ ] Compose stack scaffold (AC: 1)
  - [ ] Create root `docker-compose.yml` with services: `web`, `api`, `worker`, `postgres`, shared network and volumes [Source: docs/architecture/infrastructure-and-deployment.md]
  - [ ] Map ports: API `3001`, Web `3000`; configure `depends_on` for `api`/`worker` → `postgres` [Source: docs/architecture/infrastructure-and-deployment.md]
  - [ ] Add API healthcheck hitting `GET http://localhost:3001/healthz` [Source: docs/architecture/rest-api-spec.md#/healthz]
  - [ ] Configure image builds for `apps/web`, `apps/api`, `apps/worker` as per monorepo layout [Source: docs/architecture/source-tree.md]

- [ ] Environment and config validation (AC: 2)
  - [ ] Add `.env.example` with `DATABASE_URL`, `SESSION_SECRET` (for cookie sessions), `ENCRYPTION_KEY`, `INITIAL_ADMIN` [Source: docs/architecture/tech-stack.md; docs/architecture/security.md]
  - [ ] Load env via `@fastify/env` + `dotenv-flow` and fail fast on missing required keys [Source: docs/architecture/tech-stack.md]
  - [ ] Ensure all services read env via shared config helper (no direct `process.env` in feature code) [Source: docs/architecture/coding-standards.md]

- [ ] Database migrations on boot (AC: 3)
  - [ ] Add Prisma with initial schema and migrations for `admin_users`, `connectors`, `calendars`, `sync_pairs`, `sync_jobs`, `audit_logs` [Source: docs/architecture/database-schema.md]
  - [ ] Configure API to run migrations on startup before serving traffic [Source: docs/architecture/infrastructure-and-deployment.md]

- [ ] Health endpoints and heartbeat (AC: 4)
  - [ ] Implement API route `GET /healthz` returning 200 when DB and encryption key are ready; 503 otherwise [Source: docs/architecture/rest-api-spec.md#/healthz]
  - [ ] Add worker heartbeat: periodic log line and/or metrics endpoint confirming liveness within 5 seconds of start [Source: docs/architecture/local-development.md#verify-health]

- [ ] Smoke tests and docs (AC: 1–4)
  - [ ] Write E2E smoke script: `docker compose up -d` → poll `GET http://localhost:3001/healthz` ≤ 5s [Source: docs/architecture/ops-runbook.md]
  - [ ] Document local run steps in `docs/architecture/local-development.md` if any deltas arise [Source: docs/architecture/local-development.md]

# Dev Notes
- Previous Story Insights
  - No previous stories. This is the first in Epic 1.

- Data Models
  - Core tables to exist after first boot: `admin_users`, `connectors`, `calendars`, `sync_pairs`, `sync_jobs`, `audit_logs` [Source: docs/architecture/database-schema.md]

- API Specifications
  - Health probe: `GET /healthz` → 200 when DB + encryption key ready; 503 with reason on failure [Source: docs/architecture/rest-api-spec.md#/healthz]

- Component/Service Specifications
  - Services: `apps/web` (Next.js 15 portal), `apps/api` (Fastify API), `apps/worker` (Node worker) [Source: docs/architecture/source-tree.md; docs/architecture/high-level-architecture.md]

- File Locations
  - Root `docker-compose.yml`, `.env.example` [Source: docs/architecture/source-tree.md]
  - API entry: `apps/api/src/server.ts` with routes under `apps/api/src/routes` [Source: docs/architecture/source-tree.md]
  - Worker entry: `apps/worker/src/main.ts` [Source: docs/architecture/source-tree.md]
  - Prisma schema: `prisma/schema.prisma`; migrations under `prisma/migrations/` [Source: docs/architecture/source-tree.md]

- Testing Requirements
  - Unit: Vitest for helpers/utilities; colocate `*.test.ts` [Source: docs/architecture/test-strategy-and-standards.md]
  - Integration: API `healthz` and DB connectivity; worker startup heartbeat [Source: docs/architecture/test-strategy-and-standards.md]
  - E2E: Compose smoke—bring up stack and verify API health within SLA [Source: docs/architecture/ops-runbook.md]

- Technical Constraints
  - Node.js 22.17.0; TypeScript 5.9.2; Docker Engine ≥26, Compose v2.39.3 [Source: docs/architecture/tech-stack.md]
  - Use Pino for logging; no `console.log` in feature code [Source: docs/architecture/coding-standards.md]
  - Env/Secrets via `@fastify/env` and shared config utilities; no direct `process.env` [Source: docs/architecture/coding-standards.md; docs/architecture/tech-stack.md]

## Testing
- Place unit tests next to sources as `*.test.ts` (Vitest). Integration tests under `apps/api/tests/integration` and `apps/worker/tests/integration`. For this story, include:
  - API: `/healthz` returns 200 when DB connected and encryption key present; 503 when missing [Source: docs/architecture/rest-api-spec.md#/healthz; docs/architecture/test-strategy-and-standards.md]
  - Worker: startup logs heartbeat within 5 seconds [Source: docs/architecture/local-development.md]
  - E2E: Compose smoke—bring up stack and verify API health within SLA [Source: docs/architecture/ops-runbook.md]

# Change Log
| Date       | Version | Description        | Author |
|------------|---------|--------------------|--------|
| 2025-09-18 | v0.1    | Initial draft      | Scrum Master |

# Dev Agent Record
## Agent Model Used

## Debug Log References

## Completion Notes List

## File List

# QA Results

