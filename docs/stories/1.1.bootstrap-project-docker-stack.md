# Status
Ready for Review

# Story
**As a** self-hosting administrator,
**I want** to run a single `docker compose up` command,
**so that** the web app, API, worker, and Postgres come online with sensible defaults.

# Acceptance Criteria
1. `docker-compose.yml` defines web, api, worker, and Postgres services with shared network/volumes.
2. `.env.example` lists required variables (DB credentials, JWT/Session secret, initial admin flag) and startup fails fast if any are missing.
3. API performs database migrations on first boot to create core tables (admin_users, calendars, connectors, sync_jobs, audit_logs).
4. API `/healthz` and worker heartbeat output are observable successfully within 5 seconds of stack start.

# Tasks / Subtasks
- [x] Compose stack scaffold (AC: 1)
  - [x] Create root `docker-compose.yml` with services: `web`, `api`, `worker`, `postgres`, shared network and volumes [Source: docs/architecture/infrastructure-and-deployment.md]
  - [x] Map ports: API `3001`, Web `3000`; configure `depends_on` for `api`/`worker` → `postgres` [Source: docs/architecture/infrastructure-and-deployment.md]
  - [x] Add API healthcheck hitting `GET http://localhost:3001/healthz` [Source: docs/architecture/rest-api-spec.md#/healthz]
  - [x] Configure image builds for `apps/web`, `apps/api`, `apps/worker` as per monorepo layout [Source: docs/architecture/source-tree.md]

- [x] Environment and config validation (AC: 2)
  - [x] Add `.env.example` with `DATABASE_URL`, `SESSION_SECRET` (for cookie sessions), `ENCRYPTION_KEY`, `INITIAL_ADMIN` [Source: docs/architecture/tech-stack.md; docs/architecture/security.md]
  - [x] Load env via `@fastify/env` + `dotenv-flow` and fail fast on missing required keys [Source: docs/architecture/tech-stack.md]
  - [x] Ensure all services read env via shared config helper (no direct `process.env` in feature code) [Source: docs/architecture/coding-standards.md]

- [x] Database migrations on boot (AC: 3)
  - [x] Add Prisma with initial schema and migrations for `admin_users`, `connectors`, `calendars`, `sync_pairs`, `sync_jobs`, `audit_logs` [Source: docs/architecture/database-schema.md]
  - [x] Configure API to run migrations on startup before serving traffic [Source: docs/architecture/infrastructure-and-deployment.md]

- [x] Health endpoints and heartbeat (AC: 4)
  - [x] Implement API route `GET /healthz` returning 200 when DB and encryption key are ready; 503 otherwise [Source: docs/architecture/rest-api-spec.md#/healthz]
  - [x] Add worker heartbeat: periodic log line and/or metrics endpoint confirming liveness within 5 seconds of start [Source: docs/architecture/local-development.md#verify-health]

- [x] Smoke tests and docs (AC: 1–4)
  - [x] Write E2E smoke script: `docker compose up -d` → poll `GET http://localhost:3001/healthz` ≤ 5s [Source: docs/architecture/ops-runbook.md]
  - [x] Document local run steps in `docs/architecture/local-development.md` if any deltas arise [Source: docs/architecture/local-development.md]

# Dev Notes
- Previous Story Insights
  - No previous stories. This is the first in Epic 1.

- Data Models
  - Core tables to exist after first boot: `admin_users`, `connectors`, `calendars`, `sync_pairs`, `sync_jobs`, `audit_logs` [Source: docs/architecture/database-schema.md]

- API Specifications
  - Health probe: `GET /healthz` → 200 when DB + encryption key ready; 503 with reason on failure [Source: docs/architecture/rest-api-spec.md#/healthz]

- Component/Service Specifications
  - Services: `apps/web` (Next.js 15 portal), `apps/api` (Fastify API), `apps/worker` (Node worker) [Source: docs/architecture/source-tree.md; docs/architecture/high-level-architecture.md]

- File Locations
  - Root `docker-compose.yml`, `.env.example` [Source: docs/architecture/source-tree.md]
  - API entry: `apps/api/src/server.ts` with routes under `apps/api/src/routes` [Source: docs/architecture/source-tree.md]
  - Worker entry: `apps/worker/src/main.ts` [Source: docs/architecture/source-tree.md]
  - Prisma schema: `prisma/schema.prisma`; migrations under `prisma/migrations/` [Source: docs/architecture/source-tree.md]

- Testing Requirements
  - Unit: Vitest for helpers/utilities; colocate `*.test.ts` [Source: docs/architecture/test-strategy-and-standards.md]
  - Integration: API `healthz` and DB connectivity; worker startup heartbeat [Source: docs/architecture/test-strategy-and-standards.md]
  - E2E: Compose smoke—bring up stack and verify API health within SLA [Source: docs/architecture/ops-runbook.md]

- Technical Constraints
  - Node.js 22.17.0; TypeScript 5.9.2; Docker Engine ≥26, Compose v2.39.3 [Source: docs/architecture/tech-stack.md]
  - Use Pino for logging; no `console.log` in feature code [Source: docs/architecture/coding-standards.md]
  - Env/Secrets via `@fastify/env` and shared config utilities; no direct `process.env` [Source: docs/architecture/coding-standards.md; docs/architecture/tech-stack.md]

## Testing
- Place unit tests next to sources as `*.test.ts` (Vitest). Integration tests under `apps/api/tests/integration` and `apps/worker/tests/integration`. For this story, include:
  - API: `/healthz` returns 200 when DB connected and encryption key present; 503 when missing [Source: docs/architecture/rest-api-spec.md#/healthz; docs/architecture/test-strategy-and-standards.md]
  - Worker: startup logs heartbeat within 5 seconds [Source: docs/architecture/local-development.md]
  - E2E: Compose smoke—bring up stack and verify API health within SLA [Source: docs/architecture/ops-runbook.md]

# Change Log
| Date       | Version | Description        | Author |
|------------|---------|--------------------|--------|
| 2025-09-18 | v0.1    | Initial draft      | Scrum Master |
| 2025-09-18 | v1.0    | Stack bootstrap implemented | Dev Agent |
| 2025-09-18 | v1.1    | Local dev guide aligned with env contract | Dev Agent |

# Dev Agent Record
## Agent Model Used
- GPT-5 (Codex CLI)

## Debug Log References
- n/a

## Completion Notes List
- Docker Compose stack builds app, API, worker, and Postgres images with shared network/volumes and health checks.
- Shared config package enforces env requirements via `dotenv-flow` + `@fastify/env`; services consume typed helpers.
- Prisma schema and bootstrap migration added; API executes migrations before listening.
- `/healthz` readiness route and worker heartbeat loop implemented with Vitest coverage.
- Added `npm run smoke` helper and documented the local development flow.
- Validated `npm run build`, `npm run test`, and `npm run smoke`.
- Synced local development guide instructions with `ENCRYPTION_KEY`/`INITIAL_ADMIN` expectations and re-ran `npm test` post-update.

## File List
- docker-compose.yml
- .env.example
- package.json
- package-lock.json
- tsconfig.base.json
- vitest.config.ts
- scripts/smoke.mjs
- apps/api/Dockerfile
- apps/api/package.json
- apps/api/tsconfig.json
- apps/api/src/server.ts
- apps/api/src/lib/migrate.ts
- apps/api/src/plugins/prisma.ts
- apps/api/src/routes/health.ts
- apps/api/src/routes/health.test.ts
- apps/worker/Dockerfile
- apps/worker/package.json
- apps/worker/tsconfig.json
- apps/worker/src/main.ts
- apps/worker/src/worker.ts
- apps/worker/src/worker.test.ts
- apps/web/Dockerfile
- apps/web/next.config.mjs
- apps/web/package.json
- apps/web/tsconfig.json
- apps/web/next-env.d.ts
- apps/web/public/.gitkeep
- packages/config/package.json
- packages/config/tsconfig.json
- packages/config/src/index.ts
- packages/config/src/logging.ts
- packages/core/package.json
- packages/core/tsconfig.json
- packages/core/src/index.ts
- prisma/schema.prisma
- prisma/migrations/20250101000000_bootstrap/migration.sql
- docs/architecture/infrastructure-and-deployment.md
- docs/architecture/local-development.md

# QA Results
- ✅ `docs/architecture/local-development.md:19-71` now references `ENCRYPTION_KEY`, documents `INITIAL_ADMIN`, and limits first-run checks to `/healthz`, so following the guide lets the compose stack boot successfully.
- ✅ `npm test`
