# Status
Ready for Review

# Story
**As a** administrator,
**I want** to authorize Google and Microsoft calendars via OAuth,
**so that** SynCal can sync events with minimal manual setup.

# Acceptance Criteria
1. Connector wizard offers Google and Microsoft options with scope descriptions and consent instructions.
2. Completing OAuth stores encrypted access/refresh tokens plus calendar metadata in Postgres.
3. Wizard allows selecting one or more calendars discovered via API and records their IDs.
4. Post-setup validation fetches upcoming events to confirm API connectivity and displays success/failure feedback.

# Tasks / Subtasks
- [x] Portal connector wizard experience (AC: 1, 3, 4)
  - [x] Extend the connector wizard to include Google and Microsoft cards with scope copy, consent prerequisites, and stepper guidance per the UI specification. [Source: docs/architecture/front-end-spec.md#connector-wizard]
  - [x] Trigger provider consent windows using environment configuration and persist opaque state for CSRF so the callback can correlate the admin session. [Source: docs/architecture/security.md#authentication--authorization]
  - [x] After successful callbacks, call the API to fetch discovered calendars, render multi-select with labels, and require at least one calendar selection before confirmation. [Source: docs/architecture/core-workflows.md#connector-onboarding--validation]
  - [x] Surface inline validation panels, success toasts, and actionable error copy consistent with wizard validation rules, blocking advancement on failures. [Source: docs/architecture/front-end-spec.md#validation]

- [x] OAuth callback handling and token exchange (AC: 1, 2)
  - [x] Implement `GET /auth/google/callback` and `GET /auth/microsoft/callback` to validate `code/state`, exchange tokens with provider SDKs, and associate the flow with the authenticated admin session. [Source: docs/architecture/rest-api-spec.md (/auth/google/callback; /auth/microsoft/callback)]
  - [x] Use the connectors library to normalize token payloads and provider profile details, encapsulating provider-specific logic behind the adapter contract. [Source: docs/architecture/components.md#connectors-library]
  - [x] Encrypt access/refresh tokens with the libsodium-based helper before persisting connector records, ensuring secrets are never logged. [Source: docs/architecture/security.md#secrets-management]
  - [x] Validate all query parameters and request payloads with Zod and enforce CSRF/session checks prior to processing. [Source: docs/architecture/security.md#input-validation]

- [x] Connector persistence and calendar storage (AC: 2, 3)
  - [x] Persist connector metadata, encrypted credentials, and provider configuration into the `connectors` table using Prisma, keeping `config_json` in sync with selected calendars. [Source: docs/architecture/database-schema.md]
  - [x] Insert or update calendar rows per selected provider calendar IDs, storing display names and privacy defaults as defined by the data model. [Source: docs/architecture/data-models.md#calendar]
  - [x] Record audit log entries for connector creation and calendar linkage to maintain traceability. [Source: docs/architecture/data-models.md#auditlog]
  - [x] Return updated connector objects through `POST /connectors` so the portal wizard can reflect current status. [Source: docs/architecture/rest-api-spec.md (/connectors)]

- [ ] Post-setup validation workflow (AC: 2, 4)
  - [x] Invoke connector adapters to fetch upcoming events immediately after calendar selection, displaying success metrics or actionable error details in the wizard summary. [Source: docs/architecture/core-workflows.md#connector-onboarding--validation]
  - [x] Persist validation results (`status`, `last_validated_at`) and ensure failure states surface alerts that direct admins to retry. [Source: docs/architecture/database-schema.md; docs/architecture/components.md#portal-nextjs-app]
  - [x] Queue a follow-up validation job via the existing job scheduling mechanism to keep connectors fresh without manual intervention. [Source: docs/architecture/rest-api-spec.md (/jobs/schedule)]

- [ ] Automated testing (AC: 1â€“4)
  - [x] Add unit tests exercising OAuth state validation, token encryption helpers, and calendar parsing logic. [Source: docs/architecture/test-strategy-and-standards.md#unit-tests]
  - [x] Add integration tests stubbing Google and Microsoft APIs to cover success, consent denial, and token exchange failures. [Source: docs/architecture/test-strategy-and-standards.md#integration-tests]
  - [x] Extend Playwright flows to complete the wizard end-to-end, including calendar selection, validation feedback, and error states. [Source: docs/architecture/test-strategy-and-standards.md#end-to-end-tests]

# Dev Notes
- Previous Story Insights
  - Maintain consistent use of the base64-encoded `ENCRYPTION_KEY` helper when handling any connector secrets to align with the documented local development setup and avoid regressions flagged in earlier doc sweeps. [Source: docs/architecture/local-development.md#1-environment-setup]

- Data Models
  - Connector records capture `type`, `status`, `credentials_encrypted`, `config_json`, and timestamps; calendars linked to connectors store provider IDs, display names, privacy modes, and metadata with uniqueness enforced per connector. [Source: docs/architecture/database-schema.md]

- API Specifications
  - OAuth callbacks for Google and Microsoft redirect back to the portal after code exchange, while `POST /connectors` creates connector records and triggers validation workflows; scheduled validations can be enqueued via `POST /jobs/schedule`. [Source: docs/architecture/rest-api-spec.md (/auth/google/callback; /auth/microsoft/callback; /connectors; /jobs/schedule)]

- Component Specifications
  - The portal wizard uses a modal/drawer stepper with inline validation, toasts, and fallback prompts; connector adapters live in `packages/connectors`, exposing uniform `validate` and token management helpers for all providers. [Source: docs/architecture/front-end-spec.md#connector-wizard; docs/architecture/components.md#connectors-library]

- External Provider Contracts
  - Google Calendar and Microsoft Graph connectors rely on OAuth 2.0 authorization code flows with offline scopes, fetching calendars and events via documented endpoints while respecting provider quotas and delta tokens. [Source: docs/architecture/external-apis.md#google-calendar-api; docs/architecture/external-apis.md#microsoft-graph-calendar-api]

- Provider Credentials Setup
  - Reference documented scopes, consent screen configuration, and authorized redirect URIs when registering the apps. [Source: docs/prd/provider-credentials-setup.md]

- Core Workflow Considerations
  - Connector onboarding requires a successful callback, metadata fetch, calendar selection, confirmation, and a validation step that surfaces success or retry instructions before prompting for fallback ordering. [Source: docs/architecture/core-workflows.md#connector-onboarding--validation]

- File Locations
  - Portal wizard components live under `apps/web/src/app/(connectors)` with shared UI primitives in `packages/ui`; API routes belong in `apps/api/src/routes`, Prisma schema under `prisma/schema.prisma`, and connectors logic within `packages/connectors/src`. [Source: docs/architecture/source-tree.md]

- Technical Constraints
  - Implementations target Node.js 22.17.0 and TypeScript 5.9.2, use Fastify 5.6.0 with Zod validation on the API, and rely on libsodium-backed encryption plus Tailwind/ShadCN for UI components. [Source: docs/architecture/tech-stack.md]

## Testing
- Follow Vitest for unit scenarios colocated with sources and ensure coverage includes state validation, token helpers, and adapter interactions. [Source: docs/architecture/test-strategy-and-standards.md#unit-tests]
- Use integration suites in `apps/api/tests/integration` and `apps/worker/tests/integration` with provider stubs to cover OAuth callbacks, calendar ingestion, and queued validations. [Source: docs/architecture/test-strategy-and-standards.md#integration-tests]
- Extend Playwright E2E specs to drive the connector wizard, verifying success toasts, validation messaging, and calendar persistence for both providers. [Source: docs/architecture/test-strategy-and-standards.md#end-to-end-tests]

# Change Log
| Date       | Version | Description    | Author       |
|------------|---------|----------------|--------------|
| 2025-09-22 | v0.1    | Initial draft  | Scrum Master |
| 2025-09-22 | v0.2    | Updated story formatting, references, and dev notes | Product Owner |
| 2025-09-22 | v1.0    | Implemented Google/Microsoft OAuth wizard, API callbacks, validation jobs, and automated tests | Dev Agent |

# Dev Agent Record
## Agent Model Used

- Codex (GPT-5)

## Debug Log References

- npm test

## Completion Notes List

- Implemented backend OAuth start/callback flow with encrypted credential storage, connector persistence, and validation metadata.
- Built front-end wizard for Google and Microsoft connectors including consent launch, calendar selection, and review workflow.
- Added unit coverage for session state helpers and connector adapters; updated environment schema and security helpers.
- Scheduled automatic connector revalidation jobs and captured new integration/E2E coverage for OAuth success, consent denial, and error states.

## File List

- apps/api/src/lib/oauth.ts
- apps/api/src/lib/oauth.test.ts
- apps/api/src/plugins/connectors.ts
- apps/api/src/routes/auth/oauth.ts
- apps/api/src/routes/connectors/index.ts
- apps/api/src/services/connectors.ts
- apps/web/src/app/(connectors)/connectors/page.tsx
- packages/config/src/secrets.ts
- packages/core/src/dtos/connectors.ts
- apps/api/tests/integration/connectors.oauth.test.ts
- apps/web/tests/e2e/connectors.spec.ts
- package.json
- vitest.config.ts
- packages/connectors/
- packages/connectors/src/index.ts

# QA Results
