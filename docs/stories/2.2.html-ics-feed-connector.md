# Status
Draft

# Story
**As a** administrator,
**I want** to link read-only HTML/ICS calendar feeds,
**so that** SynCal can ingest events when OAuth is unavailable.

# Acceptance Criteria
1. Setup form accepts feed URL, optional auth header/token, and target calendar label.
2. Submission fetches the feed, validates HTTP 200, parses iCal data, and previews five upcoming events.
3. Validation errors (401/403/network/parse) display actionable messages and block saving until resolved.
4. Connector list shows masked URL, last successful fetch timestamp, and current status badge.

# Tasks / Subtasks
- [ ] Implement HTML/ICS connector wizard support (AC: 1, 2, 3)
  - [ ] Add an HTML/ICS option in the connector wizard type step with guidance that the feed is read-only and requires URL plus optional auth header/token fields. [Source: docs/architecture/front-end-spec.md#connector-setup-oauth--html-ics--imap--self-managed]
  - [ ] Capture the target calendar label alongside feed credentials so the portal can apply the label when persisting the connector. [Source: docs/prd/epic-2-connector-configuration-validation.md#story-22-htmlics-feed-connector]
  - [ ] Validate URL, header/token inputs with inline error states and prevent advancing until the feed test passes or the admin corrects errors. [Source: docs/architecture/front-end-spec.md#connector-setup-oauth--html-ics--imap--self-managed]
  - [ ] Trigger the `POST /connectors/validate` endpoint from the wizard “Test feed” action using the configured feed URL, auth header/token, and target calendar label, then render the five-event preview plus actionable error messaging via the shared submission feedback component. [Source: docs/architecture/core-workflows.md#connector-onboarding--validation; docs/architecture/rest-api-spec.md#/connectors; docs/architecture/front-end-spec.md#connector-setup-oauth--html-ics--imap--self-managed]

- [ ] Add HTML/ICS connector adapter and validation flow (AC: 2, 3)
  - [ ] Create `packages/connectors/src/adapters/html-ics` implementing `ConnectorAdapter.validate` to fetch the feed with optional auth header/token, enforce the shared 30s external API timeout, and parse events using node-ical. [Source: docs/architecture/components.md#connectors-library; docs/architecture/external-apis.md#htmlics-feeds; docs/architecture/error-handling-strategy.md#external-api-errors]
  - [ ] Register the adapter in `packages/connectors/src/registry.ts` (and any factory wiring) so API and worker services can resolve the new type. [Source: docs/architecture/components.md#connectors-library]
  - [ ] Normalize parsed events (limit to next five upcoming) and surface validation failures for status codes, network errors, or malformed ICS payloads with structured error metadata for the portal. [Source: docs/architecture/external-apis.md#htmlics-feeds; docs/architecture/core-workflows.md#connector-onboarding--validation]
  - [ ] Respect IANA timezone identifiers (`TZID`) and all-day flags when normalizing events so previews reflect provider-local time correctly. [Source: docs/architecture/external-apis.md#htmlics-feeds]
  - [ ] Unit test adapter helpers to cover success, 401/403, timeout, malformed payload, and recurrence/timezone scenarios using Vitest. [Source: docs/architecture/test-strategy-and-standards.md#unit-tests]

- [ ] Extend API connectors service for HTML/ICS configuration (AC: 1, 2, 3)
  - [ ] Update DTOs and Zod schemas for `POST /connectors` to accept the `html_ics` type with feed URL, human-readable target calendar label (returned verbatim), and optional auth header/token stored encrypted via libsodium helpers. [Source: docs/architecture/rest-api-spec.md#/connectors; docs/architecture/database-schema.md#database-schema; docs/architecture/security.md#secrets-management]
  - [ ] Expose and document `POST /connectors/validate` (request body mirroring wizard inputs, response containing preview events and validation status) so the portal and API share the same contract. [Source: docs/architecture/rest-api-spec.md#/connectors; docs/architecture/core-workflows.md#connector-onboarding--validation]
  - [ ] Persist the raw feed URL and secret header/token in the encrypted credentials payload so validation jobs can resolve the original values while only exposing masked variants externally. [Source: docs/architecture/security.md#secrets-management; docs/architecture/coding-standards.md#critical-rules]
  - [ ] Add a migration to add `last_successful_fetch_at TIMESTAMPTZ` to the `connectors` table and ensure the API response returns the masked URL, preview events, and timestamp currently used by the portal list. [Source: docs/architecture/database-schema.md#database-schema; docs/architecture/core-workflows.md#connector-onboarding--validation]
  - [ ] Persist connector `config_json` with masked URL plus preview metadata, update `last_validated_at` on success, and return validation results—including preview events and validation status—to the portal. [Source: docs/architecture/database-schema.md#connectors-json-metadata; docs/architecture/core-workflows.md#connector-onboarding--validation]
  - [ ] Store validation metadata in a structured shape (masked URL, preview events, last successful fetch timestamp, validation issues/status) under `config_json.validationMetadata`, matching the DTO contract expected by the portal. [Source: docs/architecture/rest-api-spec.md#/components/schemas/ConnectorValidationResult; docs/architecture/database-schema.md#connectors-json-metadata]
  - [ ] Create or update `calendars` records tied to the connector using the admin-supplied target calendar label so downstream sync jobs can route events correctly. [Source: docs/architecture/data-models.md#calendar; docs/prd/epic-2-connector-configuration-validation.md#story-22-htmlics-feed-connector]
  - [ ] Define and implement a consistent masking strategy (e.g., keep scheme + host + obfuscated path tail) when serializing the feed URL so UI and API display match. Document the rule alongside DTO changes. [Source: docs/architecture/security.md#secrets-management]
  - [ ] Update `docs/architecture/database-schema.md` to describe the new `last_successful_fetch_at` column and encrypted credential fields added for HTML/ICS connectors. [Source: docs/architecture/database-schema.md]
  - [ ] Add integration coverage in `apps/api/tests/integration` to verify validation success, 401/403 errors, and parse failures propagate meaningful messages. [Source: docs/architecture/test-strategy-and-standards.md#integration-tests]

- [ ] Schedule and process HTML/ICS sync jobs (AC: 2, 4)
  - [ ] Ensure connector creation enqueues or updates worker jobs so the HTML/ICS adapter runs during sync windows while honoring the existing Postgres-backed job queue contract. [Source: docs/architecture/core-workflows.md#sync-job-lifecycle; docs/architecture/components.md#sync-worker]
  - [ ] Update worker execution to record `last_successful_fetch_at` using the shared persistence layer, apply retry/backoff on failures, and emit user-facing status codes for the portal. [Source: docs/architecture/error-handling-strategy.md#external-api-errors; docs/architecture/components.md#sync-worker]
  - [ ] Store and reuse `ETag`/`Last-Modified` headers from successful fetches in the connector `config_json.fetchCache` block so subsequent syncs can perform conditional requests and reduce load, falling back gracefully when headers are absent. [Source: docs/architecture/external-apis.md#htmlics-feeds; docs/architecture/database-schema.md#connectors-json-metadata; docs/architecture/core-workflows.md#sync-job-lifecycle]
  - [ ] Write worker integration tests covering successful ingestion, network timeout retry, and permanent failure leading to paused connector state. [Source: docs/architecture/test-strategy-and-standards.md#integration-tests]

- [ ] Update connector list UI for HTML/ICS metadata (AC: 4)
  - [ ] Display masked feed URL, last successful fetch timestamp, and status badge for HTML/ICS connectors within the connector list cards. [Source: docs/prd/epic-2-connector-configuration-validation.md#story-22-htmlics-feed-connector; docs/architecture/front-end-spec.md#component-inventory]
  - [ ] Surface validation error banners and retry actions consistent with existing connector list interactions. [Source: docs/architecture/front-end-spec.md#component-inventory]
  - [ ] Add Playwright coverage to exercise the HTML/ICS connector lifecycle including error states and dashboard status chips. [Source: docs/architecture/test-strategy-and-standards.md#end-to-end-tests]

- [ ] Ensure automated testing and quality gates (AC: 1–4)
  - [ ] Maintain 80% coverage for connectors package and API modules, include axe accessibility scan for the wizard, and document test data fixtures in `packages/testing`. [Source: docs/architecture/test-strategy-and-standards.md]
  - [ ] Update CI workflows if new scripts are required to run HTML/ICS-specific tests. [Source: docs/architecture/test-strategy-and-standards.md#continuous-testing]

# Dev Notes
- Previous Story Insights
  - Reuse the connector wizard structure, submission feedback helper, and job scheduling patterns introduced for Google/Microsoft connectors to keep UX and validation flows consistent. [Source: docs/stories/2.1.google-microsoft-oauth-connector-flow.md#dev-agent-record]

- Data Models
  - `connectors` rows store type (`html_ics`), status, encrypted credentials (including raw feed URL + optional auth header/token), JSON config (including `validationMetadata` and `fetchCache` payloads), validation timestamps, and the new `last_successful_fetch_at` column surfaced in the portal list; related calendar rows capture provider IDs, display names, privacy modes, and metadata. [Source: docs/architecture/database-schema.md#database-schema; docs/architecture/database-schema.md#connectors-json-metadata]
  - HTML/ICS connectors persist the wizard-supplied target calendar label in the related calendar `display_name`, ensuring the same value flows through the `targetCalendarLabel` DTO. [Source: docs/architecture/data-models.md#calendar]

- API Specifications
  - `POST /connectors` creates connectors and triggers validation, returning masked URL (format: `<scheme>://<host>/…/<last-path>`), preview events shaped per `ConnectorValidationResult.previewEvents`, target calendar label, and `last_successful_fetch_at`; `POST /connectors/validate` accepts wizard-provided credentials to perform test runs and returns preview/error payloads; `GET /connectors` and `PATCH /connectors/{id}` surface the same metadata used by the portal; scheduling validations leverages `POST /jobs/schedule`. [Source: docs/architecture/rest-api-spec.md#/connectors; docs/architecture/core-workflows.md#connector-onboarding--validation]

- Component Specifications
  - Connector wizard runs in a modal/drawer with inline validation, async test buttons, review step, and fallback prompts, while connector list cards display status badges and actions. [Source: docs/architecture/front-end-spec.md#connector-setup-oauth--html-ics--imap--self-managed; docs/architecture/front-end-spec.md#component-inventory]
  - Connector registry requires registering the HTML/ICS adapter so the API/service layer resolves the type consistently. [Source: docs/architecture/components.md#connectors-library]

- External Provider Contracts
  - HTML/ICS feeds are accessed via user-supplied HTTPS URLs with optional auth headers; use node-ical, respect `ETag`/`Last-Modified` (persist values for conditional requests in `config_json.fetchCache`), validate HTTP 200 and `text/calendar`, and treat duplicates or partial data gracefully. [Source: docs/architecture/external-apis.md#htmlics-feeds; docs/architecture/database-schema.md#connectors-json-metadata]

- Error Handling & Retries
  - Apply the shared external API error strategy: enforce the 30s HTML/ICS fetch timeout from the error-handling spec, use exponential backoff with jitter, and apply connector failure counters that pause connectors after repeated failures. [Source: docs/architecture/error-handling-strategy.md#external-api-errors]

- Security & Secrets
  - Secrets (auth header/token) and the raw feed URL must be encrypted with libsodium sealed box utilities, never logged, and accessed via the shared config helpers instead of `process.env`. Serialize encrypted payload fields as `feed_url`, `auth_header`, and `auth_token` so DTO/schema updates stay consistent. [Source: docs/architecture/security.md#secrets-management; docs/architecture/coding-standards.md#critical-rules]

- File Locations
  - Portal wizard and connector list live under `apps/web/src/app/(connectors)`, API routes/services under `apps/api/src`, connectors adapters within `packages/connectors/src/adapters/html-ics`, and tests under the prescribed Vitest/Playwright directories. [Source: docs/architecture/source-tree.md]

- Testing Requirements
  - Unit tests colocated with adapters/services, integration tests under `apps/api/tests/integration` and `apps/worker/tests/integration` (including assertions for `last_successful_fetch_at` propagation, calendar record creation, masked URL format, and conditional fetch headers), Playwright E2E for wizard flow, and axe accessibility checks for UI steps. [Source: docs/architecture/test-strategy-and-standards.md]

- Technical Constraints
  - Implement with TypeScript 5.9.2 on Node.js 22.17.0, Fastify 5.6 for API, Prisma 6.16 for persistence, Tailwind/shadcn for UI, and shared DTOs via `packages/core`. [Source: docs/architecture/tech-stack.md; docs/architecture/coding-standards.md]

- Project Structure Notes
  - `packages/connectors/src/adapters/html-ics` path already exists in the prescribed source tree, and no structural conflicts were identified for adding wizard or worker assets. [Source: docs/architecture/source-tree.md]

## Testing
- Unit: Adapter parsing/validation helpers (success, auth failure, timeout, malformed payload, recurrence/timezone) using Vitest alongside source files. [Source: docs/architecture/test-strategy-and-standards.md#unit-tests]
- Integration: API validation endpoint and worker job runs covering success, retriable failures, masked URL serialization, calendar record creation, and conditional fetch header reuse with Testcontainers-backed suites. [Source: docs/architecture/test-strategy-and-standards.md#integration-tests]
- E2E: Playwright flow for creating an HTML/ICS connector, verifying preview/error states, and confirming status badges plus masked URLs on the connector list. [Source: docs/architecture/test-strategy-and-standards.md#end-to-end-tests]

# Change Log
| Date       | Version | Description        | Author       |
|------------|---------|--------------------|--------------|
| 2025-09-23 | v0.6    | Linked config JSON and calendar label guidance to architecture sources; documented new connector column | Product Owner |
| 2025-09-23 | v0.5    | Clarified target label handling, connector persistence fields, timeout, and cache metadata locations | Product Owner |
| 2025-09-23 | v0.4    | Documented timezone normalization and validation metadata storage requirements | Product Owner |
| 2025-09-23 | v0.3    | Clarified validation endpoint contract and timeout guidance | Product Owner |
| 2025-09-23 | v0.2    | Expanded persistence/masking requirements | Product Owner |
| 2025-09-23 | v0.1    | Initial draft | Scrum Master |

# Dev Agent Record
## Agent Model Used

- _TBD_

## Debug Log References

- _TBD_

## Completion Notes List

- _TBD_

## File List

- _TBD_

# QA Results
- _TBD_
