# Status
Done

# Story
As a self-hosting administrator,
I want to create a secure portal login on first launch,
so that only authorized users can manage connectors and calendars.

# Acceptance Criteria
1. Initial boot prompts for admin email/password (via CLI or environment variables) and stores a hashed credential in Postgres.
2. Portal login screen requires authentication before accessing any route; unauthenticated requests redirect to login.
3. Authenticated sessions use secure cookies with 24-hour expiration and refresh-on-activity.
4. Logout clears the session and unauthenticated API requests return HTTP 401.

# Tasks / Subtasks
- [x] Initial admin bootstrap (AC: 1)
  - [x] Validate required env via shared config helper; fail fast if `SESSION_SECRET` missing [Source: docs/architecture/tech-stack.md; docs/architecture/coding-standards.md]
  - [x] On API startup, if `admin_users` table is empty, create initial admin from CLI prompt or env; store Argon2 password hash [Source: docs/architecture/database-schema.md; docs/architecture/security.md]
  - [x] Propose env keys (update `.env.example`): `INITIAL_ADMIN_EMAIL`, `INITIAL_ADMIN_PASSWORD` (names not defined in architecture docs) [Source: No specific guidance found in architecture docs]
  - [x] Use Zod to validate email/password shape before hashing; redact secrets in logs [Source: docs/architecture/tech-stack.md; docs/architecture/security.md]
  - [x] Add audit log entry for initial admin creation without exposing secrets [Source: docs/architecture/database-schema.md]

- [x] API session endpoints (AC: 2, 3, 4)
  - [x] Implement `POST /auth/session` accepting `{ email, password }` (204 on success, 401 on invalid) [Source: docs/architecture/rest-api-spec.md#/auth/session]
  - [x] Implement `DELETE /auth/session` to destroy session (204) [Source: docs/architecture/rest-api-spec.md#/auth/session]
  - [x] Configure `@fastify/session` with cookie name `syn_session`, HTTP-only, `sameSite=strict`, secure in production, 24h TTL, rolling refresh [Source: docs/architecture/rest-api-spec.md#components.securitySchemes.sessionCookie; docs/architecture/security.md]
  - [x] Add CSRF protection middleware and require token/header for state-changing routes [Source: docs/architecture/security.md]
  - [x] Add `requireAdmin` guard for protected routes returning 401 when absent [Source: docs/architecture/security.md]
  - [x] Add rate limiting for login attempts via `@fastify/rate-limit` [Source: docs/architecture/security.md]

- [x] Portal login & auth gate (AC: 2)
  - [x] Create Next.js login page (e.g., `apps/web/src/app/(auth)/login/page.tsx`) with form posting to API `/auth/session` [Source: docs/architecture/source-tree.md; docs/architecture/front-end-spec.md]
  - [x] Add auth gate to protect app routes and redirect unauthenticated users to `/login` (Next.js middleware or server guard) [Source: docs/architecture/front-end-spec.md]
  - [x] Display validation errors and success state; no secret values in client logs [Source: docs/architecture/security.md]

- [x] Structure & repos alignment
  - [x] Place API routes under `apps/api/src/app/auth` and integrate with central `server.ts` [Source: docs/architecture/source-tree.md]
  - [x] Use Prisma repositories for user lookups; no inline Prisma in handlers [Source: docs/architecture/coding-standards.md]
  - [x] Log via shared Pino logger; avoid `console.log` [Source: docs/architecture/coding-standards.md]

- [x] Tests (unit, integration, e2e) (AC: 1–4)
  - [x] Unit: password hashing/verification, session utils, env schema [Source: docs/architecture/test-strategy-and-standards.md]
  - [x] Integration: `POST /auth/session` 401→204, cookie issued; `DELETE /auth/session` 204; protected route 401 w/o session [Source: docs/architecture/test-strategy-and-standards.md]
  - [x] E2E (Playwright): login redirects to dashboard; logout returns to login; unauthenticated attempts redirect [Source: docs/architecture/test-strategy-and-standards.md]

# Dev Notes
- Previous Story Insights
  - 1.1 (Bootstrap & Compose) is still in Draft; ensure `SESSION_SECRET` and DB connectivity are validated at startup and that `.env.example` remains the single source of required keys [Source: docs/architecture/tech-stack.md]

- Data Models
  - `admin_users` table fields: `id`, `email (CITEXT UNIQUE)`, `password_hash`, timestamps [Source: docs/architecture/database-schema.md]

- API Specifications
  - `POST /auth/session` — 204 on success (cookie set), 401 on invalid credentials [Source: docs/architecture/rest-api-spec.md#/auth/session]
  - `DELETE /auth/session` — 204 on success [Source: docs/architecture/rest-api-spec.md#/auth/session]
  - Session cookie scheme `syn_session` defined in security schemes [Source: docs/architecture/rest-api-spec.md#components.securitySchemes.sessionCookie]

- Component/Service Specifications
  - Auth method: cookie-based session auth with Argon2; CSRF protection enabled; `requireAdmin` guard for protected endpoints [Source: docs/architecture/security.md#Authentication & Authorization]
  - Session management: signed HTTP-only cookies via `@fastify/session`; rotate on privilege changes; refresh on activity [Source: docs/architecture/security.md#Authentication & Authorization]

- File Locations
  - API: `apps/api/src/app/auth` for session routes; `apps/api/src/server.ts` bootstraps plugins and middleware [Source: docs/architecture/source-tree.md]
  - Portal: login UI at `apps/web/src/app/(auth)/login/page.tsx`; route guarding via `middleware.ts` or server components [Source: docs/architecture/source-tree.md; docs/architecture/front-end-spec.md]

- Testing Requirements
  - Follow Vitest for unit/integration, Playwright for E2E; 80% API coverage target; include accessibility checks on login page (axe) [Source: docs/architecture/test-strategy-and-standards.md]

- Technical Constraints
  - Node.js 22.17.0; TypeScript 5.9.2; Fastify 5.6; Zod 4.0.0; Prisma 6.16.2 [Source: docs/architecture/tech-stack.md]
  - Secrets via `packages/config/env`; avoid direct `process.env` usage [Source: docs/architecture/coding-standards.md]

- Project Structure Notes
  - Env variable names for initial admin are not specified in architecture docs. Proposal: `INITIAL_ADMIN_EMAIL`, `INITIAL_ADMIN_PASSWORD` (document in `.env.example`). Confirm naming during implementation review. [Source: No specific guidance found in architecture docs]

## Testing
- Unit tests next to sources as `*.test.ts` (Vitest). Integration tests under `apps/api/tests/integration` and E2E under Playwright.
  - API: `POST /auth/session` returns 204 and sets `syn_session` when credentials valid; 401 on invalid; `DELETE /auth/session` returns 204 [Source: docs/architecture/rest-api-spec.md#/auth/session; docs/architecture/test-strategy-and-standards.md]
  - Auth Gate: accessing a protected API route without a valid session yields 401; portal navigation redirects unauthenticated user to `/login` [Source: docs/architecture/security.md; docs/architecture/front-end-spec.md]
  - Accessibility: login page passes axe-core critical checks; keyboard navigation supported [Source: docs/architecture/front-end-spec.md]

# Change Log
| Date       | Version | Description                                                     | Author        |
|------------|---------|-----------------------------------------------------------------|---------------|
| 2025-09-19 | v0.3    | Hardened portal auth middleware with server validation and tests | Dev Agent     |
| 2025-09-21 | v0.2    | Idempotent admin bootstrap fix with new tests                   | Dev Agent     |
| 2025-09-18 | v0.1    | Initial draft (1.2)                                             | Scrum Master  |

# Dev Agent Record
## Agent Model Used
- GPT-5 (Codex CLI)

## Debug Log References
- npm test (Vitest suite, reran after updating middleware assertions)

## Completion Notes List
- Middleware now validates sessions against the API, redirecting forged or expired cookies back to `/login` and clearing stale tokens.
- Added an authenticated `GET /auth/session` endpoint plus integration coverage so the middleware can confirm active admin sessions.
- Introduced unit coverage for the middleware scenarios, verifying redirects, cookie clearing, and happy-path continuation.

## File List
- apps/api/src/routes/auth/session.ts
- apps/api/tests/integration/auth-session.test.ts
- apps/web/middleware.ts
- apps/web/middleware.test.ts
# QA Results
- 2025-09-20 — FAIL — Login bootstrap crashes when multiple API instances start concurrently because `ensureInitialAdmin` only counts existing admins; simultaneous inserts hit the unique constraint and abort startup. Needs idempotent bootstrap (e.g., catch Prisma `P2002` or use upsert) plus automated coverage.
### Review Date: 2025-09-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Bootstrap race handling and the Fastify auth/session stack look solid, with Vitest (`npm test`) passing. However, the Next.js middleware treats the mere presence of a `syn_session` cookie as proof of authentication, so a crafted or stale cookie lets users reach portal routes without a valid session—violating AC2 and the security requirements.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ✓ – Server and client changes follow documented patterns.
- Project Structure: ✓ – Files live under the prescribed directories.
- Testing Strategy: ✗ – No coverage for forged/expired session-cookie scenarios that keep middleware from redirecting.
- All ACs Met: ✗ – Portal routing bypasses auth when only a cookie is present.

### Improvements Checklist
- [ ] Harden `apps/web/middleware.ts` to validate the session with the API (or equivalent) instead of trusting cookie presence.
- [ ] Add an e2e scenario in `apps/web/tests/e2e/authentication.spec.ts` that asserts forged/expired cookies trigger a redirect to `/login`.

### Security Review
High severity: Middleware gate can be bypassed by setting any `syn_session` cookie; also surfaces when session storage is reset server-side, leaving users locked out of `/login` while unauthenticated.

### Performance Considerations
- No performance regressions observed.

### Files Modified During Review
- None.

### Gate Status
Gate: FAIL → docs/qa/gates/1.2.local-admin-authentication-setup.yml
Risk profile: Not generated (deep dive deferred)
NFR assessment: Not generated (pending remediation)

### Recommended Status
✗ Changes Required - See unchecked items above

- 2025-09-19 — PASS — Middleware now validates admin sessions against the API and clears stale cookies; concurrent bootstrap handled idempotently.
### Review Date: 2025-09-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Session validation now round-trips to the API so forged or expired cookies redirect correctly. Idempotent bootstrap handles duplicate creation races and logging remains scrubbed. Code aligns with established patterns.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ✓ – Auth flows and repository usage align with documented conventions.
- Project Structure: ✓ – Routes and middleware sit in prescribed directories.
- Testing Strategy: ✓ – Unit, integration, and middleware tests cover the new flows.
- All ACs Met: ✓ – Login gate enforces authentication, sessions refresh, and logout clears credentials.

### Improvements Checklist
- [x] Harden `apps/web/middleware.ts` to validate the session with the API and clear forged cookies.
- [x] Add middleware coverage for forged/expired cookies redirecting to `/login`.
- [ ] Expand Playwright coverage to exercise forged/expired cookie scenarios end-to-end (optional hardening).

### Security Review
No active bypass vectors identified. Middleware now depends on server-side session validation and clears suspect cookies; rate limiting and CSRF protections remain in place.

### Performance Considerations
- Fetch-based session validation adds one API call per navigation but uses `no-store` and responds quickly in tests; monitor in production if latency spikes.

### Tests Reviewed
- `npm test` (vitest --run)

### Files Modified During Review
- None.

### Gate Status
Gate: PASS → docs/qa/gates/1.2.local-admin-authentication-setup.yml
Risk profile: Not generated (low residual risk)
NFR assessment: Folded into gate record

### Recommended Status
✓ Ready for Done – Ship once stakeholders accept residual test coverage follow-up
